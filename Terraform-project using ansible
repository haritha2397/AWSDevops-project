AUTOMATED INFRASTRUCTURE PROVISIONING WITH JENKINS, TERRAFORM AND ANSIBLE DYNAMIC INVENTORY


This project demonstrates a complete DevOps automation workflow where infrastructure is provisioned and configured dynamically using a CI/CD pipeline. The pipeline is orchestrated with Jenkins, utilizing Terraform for Infrastructure as Code (IaC) and Ansible for post-provisioning configuration.
The flow includes:
Developers push Terraform code to GitHub
Jenkins automatically pulls the code and performs terraform init, plan, and apply
Executes Ansible playbooks using a dynamic inventory mechanism through a custom plugin
Infrastructure is created in a VPC with multiple EC2 instances, an Auto Scaling Group (ASG), and a Load Balancer
Failed instances (e.g., Instance-1) are automatically replaced by the ASG
Configurations are applied seamlessly across newly provisioned instances

This project emphasizes the use of custom dynamic inventory plugins to adapt Ansible automation to dynamic cloud infrastructure, ensuring scalability and real-time configuration management.

ğŸ› ï¸ Tools and Technologies
Terraform â€“ Infrastructure as Code (IaC)
Ansible â€“ Configuration management with dynamic inventory
Jenkins â€“ CI/CD orchestration
GitHub â€“ Source code version control
AWS â€“ Cloud provider (EC2, VPC, ASG, Load Balancer)
ğŸ“ Repository Structure
â”œâ”€â”€ ansible/
â”‚Â Â Â â””â”€â”€ deployment.ymlÂ Â Â Â Â Â Â Â # Ansible Playbook
â”œâ”€â”€ main.tfÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â # Terraform main configuration
â”œâ”€â”€ provider.tfÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â # AWS provider setup
â”œâ”€â”€ s3.tfÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â # S3 bucket configuration
â”œâ”€â”€ security.tfÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â # Security group rules
â”œâ”€â”€ README.mdÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â # Project documentation
ğŸ”§ Step 1: Create EC2 Instance
ğŸ”§ Step 2: Jenkins Setup
ğŸ”§ Step 3: Install Terraform
ğŸ”§ Step 4: Install Git

ğŸš€ Jenkins Pipeline Setup
pipeline {
agent any
stages {
stage ("Code") {
steps {
git branch: 'main', url: 'https://github.com/haritha2397/terraformproject.git'
}
}
}
}
ğŸ” IAM User Setup
ğŸ” 1.Â Sign in to AWS Console
Go to:Â https://console.aws.amazon.com/iam
ğŸ‘¤ 2.Â Select or Create IAM User
Navigate toÂ IAMÂ â†’Â Users
Choose an existing user or clickÂ â€œAdd userâ€
EnableÂ Programmatic accessÂ (this allows creation of access keys)
ğŸ›¡ï¸ 3.Â Set Permissions
Attach a policy like:
AdministratorAccessÂ (for full access)
Or a custom policy for limited access
ğŸ”„ 4.Â Create Access Key
Go to the userâ€™sÂ Security credentialsÂ tab
ClickÂ â€œCreate access keyâ€
ChooseÂ â€œThird-party serviceâ€Â as the intended use
This scopes the key for use in external tools like Jenkins
ğŸ“¥ 5.Â Download Credentials
Copy or download theÂ Access Key IDÂ andÂ Secret Access Key
Store them securely â€” you wonâ€™t be able to view the secret again
ğŸ” IAM Role Setup for EC2
ğŸ”¹ 1.Â Go to IAM Console
URL:Â https://console.aws.amazon.com/iam
ğŸ”¹ 2.Â Create Role
ClickÂ â€œRolesâ€Â â†’Â â€œCreate roleâ€
Trusted entity type: SelectÂ AWS service
Use case: ChooseÂ EC2
ğŸ”¹ 3.Â Attach Permissions
Choose one or more policies depending on what EC2 access you need:
You can also create aÂ custom policyÂ if you want fine-grained control.
ğŸ”¹ 4.Â Name the Role
Example:Â EC2AccessRole
ğŸ”¹ 5.Â Create Role
Review and clickÂ â€œCreate roleâ€
ğŸ”Â Attach Role to EC2 Instance
Go toÂ EC2 Console
Select your instance â†’Â ActionsÂ â†’Â SecurityÂ â†’Â Modify IAM Role
Choose the role you just created (EC2AccessRole) and attach it

âœ… Jenkins Credentials Best Practices
Instead of embeddingÂ AWS Access KeyÂ andÂ Secret KeyÂ directly in the pipeline (which is insecure), you:
Store credentials securelyÂ in Jenkins.
Inject them into the pipelineÂ using environment variables.
ğŸ”Â Steps to Configure AWS Credentials in Jenkins
Using Environment Variables via System Configuration
Steps:
Go toÂ Manage JenkinsÂ â†’Â Configure System
Scroll toÂ Global properties
CheckÂ â€œEnvironment variablesâ€
Add:
Name: access_keyÂ â†’Â Value: <paste your AWS Access Key ID>
Name: secret_keyÂ â†’Â Value: <paste your AWS Secret Access Key>
âœ…Â Jenkins Credentials Setup (Method 2)
ğŸ”Â Step-by-Step: Add AWS Access Key as Secret Text
Go toÂ Manage JenkinsÂ â†’Â CredentialsÂ â†’Â (Global)Â â†’Â Add Credentials
Fill in the fields:
Kind:Â Secret text
Secret:Â Paste your AWS Access Key
ID:Â access_key
Description:Â my access key
ğŸ” Repeat the same for theÂ Secret Access Key:
Kind:Â Secret text
Secret:Â Paste your AWS Secret Access Key
ID:Â secret_key
Description:Â my secret key
When you run the Jenkins pipeline shown in your images, theÂ variables declared using both methodsÂ are triggered and used as follows:
pipeline {
agent any
environment {
AWS_ACCESS_KEY_ID = credentials('access_key')
AWS_SECRET_ACCESS_KEY = credentials('secret_key')
}

Stage 2:
stage ("infra") {
steps {
sh '''
terraform plan
terraform $action --auto-approve
'''
}
}

Parameter Name:Â action (mention action in above code terraform $action â€“auto-approve)
Choices:
apply
destroy
ğŸ”§ Install Ansible and Dependencies
To deploy an application on your EC2 instanceÂ using Ansible without manually touching the server, you can useÂ dynamic inventory. This allows Ansible to automatically discover EC2 instances using AWS APIs.
PIP INSTALL BOTO3
No Manual SSH Needed
Ansible connects using the EC2 public DNS and your SSH key
You can define the key in your Ansible config or inventory
[root@ip-172-31-88-138Â ~]#Â ll
totalÂ 0
[root@ip-172-31-88-138Â ~]#Â cdÂ /etc/ansible/
[root@ip-172-31-88-138Â ansible]#Â ll
totalÂ 24
-rw-r--r--Â 1Â rootÂ rootÂ 19985Â JulÂ 1Â 2021Â ansible.cfg
-rw-r--r--Â 1Â rootÂ rootÂ 1016Â JulÂ 1Â 2021Â hosts
drwxr-xr-xÂ 2Â rootÂ rootÂ Â Â Â 6Â JulÂ 1Â 2021Â roles
[root@ip-172-31-88-138Â ansible]#Â vimÂ ansible.cfg

inventoryÂ Â Â Â Â  = /opt/ansible/inventory/aws_ec2.yml
host_key_checking = false
inventoryÂ Â Â Â Â  = /etc/ansible/hosts
:330â€”>enable_plugins= aws_ec2


Vim keypairname.pem  paste the keypair
ğŸš€ Run Jenkins Pipeline
Terraform configuration file to create anÂ AWS S3 bucketÂ for storing Terraform state, withÂ versioningÂ andÂ server-side encryptionÂ enabled:(devops0014/devops18 add s3.tf file) to create bucket (change key name, ami_id in the main.tf file)
âš™ï¸ Build with Parameters
Stage(â€œinitâ€){
Steps{
Script{
Sh â€˜echo -e â€œyes\nâ€ | terraform initâ€™  (do u want to save all state files â€˜yesâ€™ input to terraform init)
}}}
âš™ï¸ Build with Parameters

We mentioned a path /opt/ansible/inventory/aws_ec2.yml
Now we have to create a path mkdir -p /opt/ansible/inventory
Cd /opt/ansible/inventory
Vim aws_ec2.yml (we create this plugin because of gathering the information from slave server, in that slave server we have to execute the playbook
Playbook
---
Plugin:aws_ec2
Regions:
Us-east-1
Filters:((at what basis we have to filter the instance by using tages)
Tag:aws:autoscaling:groupName: web-server-asg  (key:value-tags for particular instance)
Playbook already mentioned in github deployment.yml file
Change ansible_ssh_private-key_file in deployment.yml

Stage(â€œdeployâ€){
Steps{
Sh â€˜ansible-playbook -i /opt/ansible/inventory/aws_ec2.yml /var/lib/Jenkins/workspace/myproject/ansible/deployment.yml â€™
( plugin there in aws_ec2.yml(collect infm from prod server), some servers through plugin in that servers execute deployment.yml file)
âš™ï¸ Build with Parameters

ğŸŒ Access Web Server via Load Balancer

ğŸ“¬ Auto Scaling Notifications
wIth these recipients:email address
check mails are getting or not if instances are terminated / started/running
(run the pipeline if terminated, new instance created)


pipeline {
agent any
environment {
AWS_ACCESS_KEY_ID = credentials('access_key')
AWS_SECRET_ACCESS_KEY = credentials('secret_key')
}
Stage(â€œinitâ€){
Steps{
Script{
Sh â€˜echo -e â€œyes\nâ€ | terraform initâ€™  (do u want to save all state files â€˜yesâ€™ input to terraform init)
}}}
stage ("infra") {
steps {
sh '''
terraform plan
terraform $action --auto-approve
'''
}
}
Stage(â€œdeployâ€){
Steps{
Sh â€˜ansible-playbook -i /opt/ansible/inventory/aws_ec2.yml /var/lib/Jenkins/workspace/myproject/ansible/deployment.yml â€™
( plugin there in aws_ec2.yml(collect infm from prod server), some servers through plugin in that servers execute deployment.yml file)
}
